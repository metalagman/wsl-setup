---
- name: Verify docker command exists
  ansible.builtin.command: which docker
  register: wsl2_docker_cmd
  changed_when: false
  failed_when: wsl2_docker_cmd.rc != 0

- name: Verify docker compose subcommand exists
  ansible.builtin.command: docker compose version
  register: wsl2_compose_cmd
  changed_when: false
  failed_when: wsl2_compose_cmd.rc != 0

- name: Create service directory
  ansible.builtin.file:
    path: /opt/claude-code-router
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure config directory exists
  ansible.builtin.file:
    path: /opt/claude-code-router/config
    state: directory
    mode: '0755'

- name: Deploy claude-code-router config.json
  ansible.builtin.copy:
    dest: /opt/claude-code-router/config/config.json
    mode: '0644'
    content: |
      {
        "APIKEY": "local-key",
        "LOG": true,
        "LOG_LEVEL": "debug",
        "API_TIMEOUT_MS": 600000,
        "HOST": "0.0.0.0",
        "Providers": [
          {
            "name": "lmstudio",
            "api_base_url": "http://host.docker.internal:1234/v1/chat/completions",
            "api_key": "lmstudio",
            "models": ["openai/gpt-oss-20b"]
          }
        ],
        "Router": {
          "default": "lmstudio,openai/gpt-oss-20b",
          "background": "lmstudio,openai/gpt-oss-20b",
          "think": "lmstudio,openai/gpt-oss-20b",
          "longContext": "lmstudio,openai/gpt-oss-20b",
          "longContextThreshold": 128000,
          "webSearch": "lmstudio,openai/gpt-oss-20b"
        }
      }

- name: Deploy docker-compose file
  ansible.builtin.copy:
    dest: /opt/claude-code-router/docker-compose.yml
    mode: '0644'
    content: |
      services:
        claude-code-router:
          image: musistudio/claude-code-router:latest
          container_name: claude-code-router
          restart: unless-stopped
          ports:
            - "3456:3456"
          volumes:
            - /opt/claude-code-router/config:/root/.claude-code-router

- name: Ensure service is running with docker compose v2
  community.docker.docker_compose_v2:
    project_src: /opt/claude-code-router
    state: present        # containers created & running
    recreate: auto        # recreate only if config or image changed
    pull: always
